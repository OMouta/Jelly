name: Release

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write  # Required to upload release assets

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '23'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build
      run: npm run build
    
    - name: Build binaries
      run: |
        npm run build:linux
        npm run build:windows  
        npm run build:mac
        
        # List what files were actually created
        ls -la binaries/
        
        # Rename binaries to match Aftman expected format
        cd binaries
        
        # Handle different possible naming patterns
        if [ -f "jelly-linux" ]; then
          mv jelly-linux jelly-linux-x86_64
        elif [ -f "jelly" ]; then
          cp jelly jelly-linux-x86_64
        fi
        
        if [ -f "jelly-win.exe" ]; then
          mv jelly-win.exe jelly-windows-x86_64.exe
        elif [ -f "jelly.exe" ]; then
          cp jelly.exe jelly-windows-x86_64.exe
        fi
        
        if [ -f "jelly-macos" ]; then
          mv jelly-macos jelly-macos-x86_64
        elif [ -f "jelly" ]; then
          cp jelly jelly-macos-x86_64
        fi
        
        # List final files
        ls -la
        
        # Create checksums for Aftman
        sha256sum jelly-linux-x86_64 > jelly-linux-x86_64.sha256 2>/dev/null || true
        sha256sum jelly-windows-x86_64.exe > jelly-windows-x86_64.exe.sha256 2>/dev/null || true
        sha256sum jelly-macos-x86_64 > jelly-macos-x86_64.sha256 2>/dev/null || true
    
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      with:
        files: |
          binaries/jelly-linux-x86_64
          binaries/jelly-linux-x86_64.sha256
          binaries/jelly-windows-x86_64.exe
          binaries/jelly-windows-x86_64.exe.sha256
          binaries/jelly-macos-x86_64
          binaries/jelly-macos-x86_64.sha256
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
